name: Publish Python 🐍 distributions 📦 to PyPI
on:
  release:
    types:
      - published
jobs:
  build-n-publish:
    name: Publish Python 🐍 distributions 📦 to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Tag components
      run: ./scripts/tag_components.sh -o $GITHUB_REF_NAME -n latest
    
    - name: Tag data explorer
      run: ./scripts/tag_explorer.sh -o $GITHUB_REF_NAME -n latest

    - name: Download distributions from test.PyPI
      run: |
        curl -LO https://test.pypi.org/fondant/fondant-$GITHUB_REF_NAME.tar.gz --output-dir dist --create-dirs
        curl -LO https://test.pypi.org/fondant/fondant-$GITHUB_REF_NAME-py3-none-any.whl --output-dir dist --create-dirs

    - name: Publish distribution 📦 to PyPI if triggered by release
      uses: pypa/gh-action-pypi-publish@v1.8.6
      with:
        name: pypi
        url: https://pypi.org/p/fondant
